<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Integration Example</title>
</head>
<body>

<!-- ============================================ -->
<!-- EXAMPLE 1: LOGIN PAGE (/auth) -->
<!-- ============================================ -->

<!-- 
    IMPORTANT: Keep ALL your existing HTML/CSS/design
    ONLY add the JavaScript function below
-->

<div id="login-page-example" style="display: none;">
    <!-- Your existing beautiful UI goes here - DON'T CHANGE IT -->
    
    <!-- Just update your "Sign in with Google" button -->
    <button onclick="handleGoogleLogin()" class="your-existing-class">
        <svg><!-- Your Google icon --></svg>
        Sign in with Google
    </button>

    <script>
        // ADD THIS FUNCTION (that's all you need!)
        function handleGoogleLogin() {
            // Redirect to FastAPI backend to start OAuth flow
            window.location.href = 'https://fastapi-eight-zeta.vercel.app/login';
        }
    </script>
</div>


<!-- ============================================ -->
<!-- EXAMPLE 2: DASHBOARD PAGE (/test_dashboard) -->
<!-- ============================================ -->

<div id="dashboard-page-example">
    <!-- Keep ALL your existing UI/CSS/design -->
    
    <!-- Example user display (adapt to your design) -->
    <div class="user-profile-section">
        <img id="userPicture" src="" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%;">
        <h2 id="userName">Loading...</h2>
        <p id="userEmail">Loading...</p>
    </div>
    
    <button onclick="refreshUserData()">Refresh User Data</button>
    <button onclick="logout()">Logout</button>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const API_BASE_URL = 'https://fastapi-eight-zeta.vercel.app';

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                token: params.get('token'),
                user_id: params.get('user_id'),
                name: params.get('name'),
                email: params.get('email'),
                picture: params.get('picture')
            };
        }

        // Display user data on page
        function displayUserData(data) {
            const userName = decodeURIComponent(data.name || 'User');
            const userEmail = decodeURIComponent(data.email || '');
            const userPicture = decodeURIComponent(data.picture || '');

            // Update DOM elements (adapt IDs to match your HTML)
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = userEmail;
            
            const pictureElement = document.getElementById('userPicture');
            if (userPicture && pictureElement) {
                pictureElement.src = userPicture;
            } else if (pictureElement) {
                pictureElement.src = 'https://via.placeholder.com/100'; // Default avatar
            }

            console.log('User data displayed:', { userName, userEmail, userPicture });
        }

        // ========================================
        // AUTHENTICATION CHECK
        // ========================================
        
        // Run when page loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            
            // Get token and user data from URL
            const params = getUrlParams();
            console.log('URL params:', params);
            
            // Check if we have a token
            if (!params.token) {
                // No token found - check localStorage
                const storedToken = localStorage.getItem('access_token');
                
                if (!storedToken) {
                    // No token at all - redirect to login
                    console.log('No token found, redirecting to login');
                    window.location.href = '/auth';
                    return;
                }
                
                console.log('Using stored token');
                // We have a stored token, but no user data in URL
                // You could fetch fresh data here or just show stored data
            } else {
                // We have a token from URL - this is a fresh login
                console.log('Fresh login detected, storing token');
                
                // Store token in localStorage
                localStorage.setItem('access_token', params.token);
                localStorage.setItem('user_id', params.user_id);
                localStorage.setItem('user_name', params.name);
                localStorage.setItem('user_email', params.email);
                localStorage.setItem('user_picture', params.picture);
                
                // Display user data
                displayUserData(params);
                
                // Clean URL (remove parameters for security)
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // ========================================
        // API FUNCTIONS
        // ========================================
        
        // Fetch fresh user data from API
        async function refreshUserData() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                alert('Please login again');
                window.location.href = '/auth';
                return;
            }

            console.log('Refreshing user data from API...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired or invalid
                        alert('Session expired. Please login again.');
                        localStorage.clear();
                        window.location.href = '/auth';
                        return;
                    }
                    throw new Error(`API error: ${response.status}`);
                }
                
                const userData = await response.json();
                console.log('User data received:', userData);
                
                // Update display
                displayUserData({
                    name: userData.name,
                    email: userData.email,
                    picture: userData.picture
                });
                
                // Update localStorage
                localStorage.setItem('user_name', userData.name);
                localStorage.setItem('user_email', userData.email);
                localStorage.setItem('user_picture', userData.picture || '');
                
                alert('✅ User data refreshed successfully!');
                
            } catch (error) {
                console.error('Error fetching user data:', error);
                alert('❌ Failed to refresh user data: ' + error.message);
            }
        }

        // Generic function to make authenticated API calls
        async function makeAuthenticatedAPICall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                alert('Please login first');
                window.location.href = '/auth';
                return null;
            }

            try {
                const options = {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };

                if (body && method !== 'GET') {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = '/auth';
                        return null;
                    }
                    throw new Error(`API error: ${response.status}`);
                }
                
                return await response.json();
                
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }

        // ========================================
        // LOGOUT FUNCTION
        // ========================================
        
        function logout() {
            console.log('Logging out...');
            
            // Clear all stored data
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_name');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_picture');
            
            // Or clear everything:
            // localStorage.clear();
            
            // Redirect to login page
            window.location.href = '/auth';
        }

        // ========================================
        // EXAMPLE: Other API Calls
        // ========================================
        
        // Example: Get all users
        async function getAllUsers() {
            try {
                const data = await makeAuthenticatedAPICall('/users');
                console.log('All users:', data);
                return data;
            } catch (error) {
                console.error('Error getting users:', error);
            }
        }

        // Example: Get auth logs
        async function getAuthLogs() {
            try {
                const data = await makeAuthenticatedAPICall('/auth-logs');
                console.log('Auth logs:', data);
                return data;
            } catch (error) {
                console.error('Error getting logs:', error);
            }
        }
    </script>
</div>


<!-- ============================================ -->
<!-- EXAMPLE 3: PROTECTED ROUTE CHECKER -->
<!-- ============================================ -->

<script>
    // Add this to ANY page that requires authentication
    // Place this script at the top of your page
    
    (function() {
        // List of pages that require authentication
        const protectedPages = [
            '/test_dashboard',
            '/profile',
            '/settings',
            '/dashboard'
        ];
        
        const currentPath = window.location.pathname;
        
        // Check if current page requires authentication
        if (protectedPages.some(page => currentPath.includes(page))) {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                console.log('Protected page accessed without token, redirecting to login');
                window.location.href = '/auth';
            }
        }
    })();
</script>


<!-- ============================================ -->
<!-- EXAMPLE 4: React/Next.js Version -->
<!-- ============================================ -->

<script type="text/babel">
    // If you're using React or Next.js, here's a complete example:
    
    import React, { useState, useEffect } from 'react';
    import { useRouter } from 'next/router'; // For Next.js

    const API_BASE_URL = 'https://fastapi-eight-zeta.vercel.app';

    // Login Page Component
    function LoginPage() {
        const handleGoogleLogin = () => {
            window.location.href = `${API_BASE_URL}/login`;
        };

        return (
            <div>
                {/* Keep all your existing beautiful UI */}
                <button onClick={handleGoogleLogin}>
                    Sign in with Google
                </button>
            </div>
        );
    }

    // Dashboard Component
    function Dashboard() {
        const router = useRouter();
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            // Get URL parameters
            const { token, name, email, picture } = router.query;

            if (!token) {
                // No token, check localStorage
                const storedToken = localStorage.getItem('access_token');
                
                if (!storedToken) {
                    // Redirect to login
                    router.push('/auth');
                    return;
                }

                // Load from localStorage
                setUser({
                    name: localStorage.getItem('user_name'),
                    email: localStorage.getItem('user_email'),
                    picture: localStorage.getItem('user_picture')
                });
                setLoading(false);
            } else {
                // Fresh login
                localStorage.setItem('access_token', token);
                localStorage.setItem('user_name', decodeURIComponent(name));
                localStorage.setItem('user_email', decodeURIComponent(email));
                localStorage.setItem('user_picture', decodeURIComponent(picture || ''));

                setUser({
                    name: decodeURIComponent(name),
                    email: decodeURIComponent(email),
                    picture: decodeURIComponent(picture || '')
                });

                // Clean URL
                router.replace('/test_dashboard', undefined, { shallow: true });
                setLoading(false);
            }
        }, [router.query]);

        const refreshUserData = async () => {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE_URL}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    setUser(data);
                    localStorage.setItem('user_name', data.name);
                    localStorage.setItem('user_email', data.email);
                    localStorage.setItem('user_picture', data.picture || '');
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        };

        const logout = () => {
            localStorage.clear();
            router.push('/auth');
        };

        if (loading) return <div>Loading...</div>;

        return (
            <div>
                {/* Keep all your existing UI */}
                <img src={user.picture} alt="Profile" />
                <h2>{user.name}</h2>
                <p>{user.email}</p>
                
                <button onClick={refreshUserData}>Refresh Data</button>
                <button onClick={logout}>Logout</button>
            </div>
        );
    }

    export { LoginPage, Dashboard };
</script>


<!-- ============================================ -->
<!-- TESTING IN BROWSER CONSOLE -->
<!-- ============================================ -->

<script>
    // Open browser console and run these commands to test:
    
    // 1. Check if token exists
    console.log('Token:', localStorage.getItem('access_token'));
    
    // 2. Test API call
    async function testAPI() {
        const token = localStorage.getItem('access_token');
        const response = await fetch('https://fastapi-eight-zeta.vercel.app/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('User data:', data);
    }
    // testAPI();
    
    // 3. Clear all data and logout
    // localStorage.clear();
    // window.location.href = '/auth';
</script>

</body>
</html>
